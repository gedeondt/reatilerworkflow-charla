{
  "name": "Retailer Happy Path Saga",
  "version": 2,
  "domains": [
    {
      "id": "order",
      "queue": "orders",
      "publishes": [
        {
          "name": "OrderPlaced",
          "start": true,
          "payloadSchema": {
            "orderId": "string",
            "lines": [
              {
                "sku": "string",
                "qty": "number"
              }
            ],
            "amount": "number",
            "address": {
              "line1": "string",
              "city": "string",
              "zip": "string",
              "country": "string"
            }
          }
        },
        {
          "name": "OrderConfirmed",
          "payloadSchema": {
            "orderId": "string",
            "status": "string"
          }
        }
      ],
      "listeners": [
        {
          "id": "order-on-PaymentCaptured",
          "delayMs": 25,
          "on": { "event": "PaymentCaptured", "fromDomain": "payments" },
          "actions": [
            {
              "type": "set-state",
              "status": "CONFIRMED"
            },
            {
              "type": "emit",
              "event": "OrderConfirmed",
              "mapping": {
                "orderId": "orderId",
                "status": { "const": "CONFIRMED" }
              }
            }
          ]
        }
      ]
    },
    {
      "id": "inventory",
      "queue": "inventory",
      "publishes": [
        {
          "name": "InventoryReserved",
          "payloadSchema": {
            "reservationId": "string",
            "orderId": "string",
            "items": [
              {
                "sku": "string",
                "qty": "number"
              }
            ],
            "amount": "number",
            "address": {
              "line1": "string",
              "city": "string",
              "zip": "string",
              "country": "string"
            }
          }
        }
      ],
      "listeners": [
        {
          "id": "inventory-on-InventoryReserved",
          "delayMs": 30,
          "on": { "event": "OrderPlaced", "fromDomain": "order" },
          "actions": [
            {
              "type": "set-state",
              "status": "RESERVED"
            },
            {
              "type": "emit",
              "event": "InventoryReserved",
              "mapping": {
                "orderId": "orderId",
                "reservationId": { "const": "RES-001" },
                "items": {
                  "arrayFrom": "lines",
                  "map": {
                    "sku": "sku",
                    "qty": "qty"
                  }
                },
                "amount": "amount",
                "address": {
                  "map": {
                    "line1": { "from": "line1" },
                    "city": { "from": "city" },
                    "zip": { "from": "zip" },
                    "country": { "from": "country" }
                  },
                  "objectFrom": "address"
                }
              }
            }
          ]
        }
      ]
    },
    {
      "id": "payments",
      "queue": "payments",
      "publishes": [
        {
          "name": "PaymentAuthorized",
          "payloadSchema": {
            "paymentId": "string",
            "orderId": "string",
            "reservationId": "string",
            "amount": "number",
            "address": {
              "line1": "string",
              "city": "string",
              "zip": "string",
              "country": "string"
            }
          }
        },
        {
          "name": "PaymentCaptured",
          "payloadSchema": {
            "paymentId": "string",
            "orderId": "string",
            "amount": "number"
          }
        }
      ],
      "listeners": [
        {
          "id": "payments-on-PaymentAuthorized",
          "delayMs": 40,
          "on": { "event": "InventoryReserved", "fromDomain": "inventory" },
          "actions": [
            {
              "type": "set-state",
              "status": "AUTHORIZED"
            },
            {
              "type": "emit",
              "event": "PaymentAuthorized",
              "mapping": {
                "paymentId": { "const": "PAY-001" },
                "orderId": "orderId",
                "reservationId": "reservationId",
                "amount": "amount",
                "address": {
                  "objectFrom": "address",
                  "map": {
                    "line1": "line1",
                    "city": "city",
                    "zip": "zip",
                    "country": "country"
                  }
                }
              }
            }
          ]
        },
        {
          "id": "payments-on-ShipmentPrepared",
          "delayMs": 30,
          "on": { "event": "ShipmentPrepared", "fromDomain": "shipping" },
          "actions": [
            {
              "type": "set-state",
              "status": "CAPTURED"
            },
            {
              "type": "emit",
              "event": "PaymentCaptured",
              "mapping": {
                "paymentId": "paymentId",
                "orderId": "orderId",
                "amount": "amount"
              }
            }
          ]
        }
      ]
    },
    {
      "id": "shipping",
      "queue": "shipping",
      "publishes": [
        {
          "name": "ShipmentPrepared",
          "payloadSchema": {
            "shipmentId": "string",
            "orderId": "string",
            "paymentId": "string",
            "amount": "number",
            "address": {
              "line1": "string",
              "city": "string",
              "zip": "string",
              "country": "string"
            }
          }
        }
      ],
      "listeners": [
        {
          "id": "shipping-on-ShipmentPrepared",
          "delayMs": 50,
          "on": { "event": "PaymentAuthorized", "fromDomain": "payments" },
          "actions": [
            {
              "type": "set-state",
              "status": "PREPARED"
            },
            {
              "type": "emit",
              "event": "ShipmentPrepared",
              "mapping": {
                "shipmentId": { "const": "SHIP-001" },
                "orderId": "orderId",
                "paymentId": "paymentId",
                "amount": "amount",
                "address": {
                  "objectFrom": "address",
                  "map": {
                    "line1": "line1",
                    "city": "city",
                    "zip": "zip",
                    "country": "country"
                  }
                }
              }
            }
          ]
        }
      ]
    }
  ]
}
